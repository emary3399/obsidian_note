### 标量子查询（Scalar Subquery）

#### 1. 定义

标量子查询是**返回单个值（单行单列）​**的特殊子查询，可以像常量一样使用。

#### 2. 关键特征

- 必须且只能返回 ​**1行1列**​ 的结果
- 如果返回多行或多列会报错
- 通常用在需要单个值的场景（如 `SELECT` 列表、`WHERE` 条件等）

#### 3. 典型示例

sql

复制

```sql
-- 1. 在 SELECT 列表中使用（计算每个产品与平均价的差值）
SELECT 
    product_name,
    price,
    price - (SELECT AVG(price) FROM products) AS price_diff
FROM products;

-- 2. 在 WHERE 条件中使用（查找高于部门平均工资的员工）
SELECT * FROM employees e
WHERE salary > (SELECT AVG(salary) FROM employees WHERE department = e.department);

-- 3. 在 ORDER BY 中使用（按自定义逻辑排序）
SELECT * FROM students
ORDER BY (SELECT score FROM exam_results WHERE student_id = students.id DESC);
```

---

### 三、核心区别对比

|特性|普通子查询|标量子查询|
|---|---|---|
|​**返回结果**​|可以是多行多列|必须单行单列|
|​**使用场景**​|WHERE/IN/EXISTS/FROM 等|需要单个值的任何位置|
|​**是否可独立执行**​|通常可以|必须能独立返回单个值|
|​**性能影响**​|可能较低效|通常更高效（返回单值）|

---

### 四、实际应用技巧

1. ​**标量子查询优化**​：  
    MySQL 8.0+ 会缓存标量子查询结果，重复使用时效率更高。
    
2. ​**避免空值问题**​：  
    标量子查询如果可能返回 `NULL`，要用 `IFNULL` 处理：
    
    sql
    
    复制
    
    ```sql
    SELECT name, (SELECT IFNULL(MAX(score), 0) FROM exams WHERE student_id = s.id) 
    FROM students s;
    ```
    
3. ​**替代 JOIN 的场景**​：  
    当只需要关联表的单个字段时，标量子查询比 JOIN 更简洁：
    
    sql
    
    复制
    
    ```sql
    -- 用标量子查询
    SELECT id, (SELECT name FROM departments WHERE id = e.department_id) 
    FROM employees e;
    
    -- 等价JOIN写法
    SELECT e.id, d.name 
    FROM employees e LEFT JOIN departments d ON e.department_id = d.id;
    ```
    

---

### 五、错误示例

sql

复制

```sql
-- 错误1：标量子查询返回多行（报错）
SELECT name FROM students 
WHERE age = (SELECT age FROM teachers);  -- 如果teachers有多条记录

-- 错误2：标量子查询返回多列（报错）
SELECT name, (SELECT id, salary FROM employees LIMIT 1) FROM departments;
```

掌握这两种查询技术，能让你写出更灵活高效的SQL语句！